name: Semantic Release

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/workflows/ci-*'
      - '.github/workflows/infra-*'
  workflow_dispatch:

jobs:
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    outputs:
      new_release_published: ${{ steps.semantic.outputs.new_release_published }}
      new_release_version: ${{ steps.semantic.outputs.new_release_version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - name: Semantic Release
        id: semantic
        uses: cycjimmy/semantic-release-action@v4
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Output
        if: steps.semantic.outputs.new_release_published == 'true'
        run: |
          echo "ðŸŽ‰ New release published: v${{ steps.semantic.outputs.new_release_version }}"

  build-images:
    name: Build Images
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release_published == 'true'
    uses: ./.github/workflows/docker-release.yml
    permissions:
      contents: read
      packages: write
    with:
      tag: v${{ needs.semantic-release.outputs.new_release_version }}
    secrets: inherit

  publish-release:
    name: Publish GitHub Release
    runs-on: ubuntu-latest
    needs: [semantic-release, build-images]
    if: needs.semantic-release.outputs.new_release_published == 'true'
    permissions:
      contents: write
    env:
      RELEASE_TAG: v${{ needs.semantic-release.outputs.new_release_version }}

    steps:
      - name: Checkout repository at tag
        uses: actions/checkout@v4
        with:
          # Full history ensures deterministic tag resolution for release notes.
          fetch-depth: 0
          ref: refs/tags/${{ env.RELEASE_TAG }}

      - name: Resolve release metadata
        id: resolve
        shell: bash
        run: |
          set -euo pipefail

          tag="${RELEASE_TAG}"

          # Enforce SemVer tags for auditability and tool compatibility.
          # Relaxed regex to allow pre-release suffixes (e.g., -rc.1)
          if ! [[ "$tag" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.]+)?$ ]]; then
            echo "Invalid tag '${tag}'. Expected vX.Y.Z or vX.Y.Z-rc.N."
            exit 1
          fi

          # Ensure tag exists locally and resolve the exact commit it points to.
          git fetch --tags --force
          if ! git rev-parse --verify "refs/tags/${tag}" >/dev/null; then
            echo "Tag '${tag}' not found."
            exit 1
          fi

          tag_commit="$(git rev-list -n 1 "$tag")"
          prev_tag="$(git describe --tags --abbrev=0 --match "v*.*.*" "${tag_commit}^" 2>/dev/null || true)"

          echo "tag=${tag}" >> "$GITHUB_OUTPUT"
          echo "version=${tag#v}" >> "$GITHUB_OUTPUT"
          echo "tag_commit=${tag_commit}" >> "$GITHUB_OUTPUT"
          echo "prev_tag=${prev_tag}" >> "$GITHUB_OUTPUT"

      - name: Generate release notes
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.resolve.outputs.tag }}"
          prev_tag="${{ steps.resolve.outputs.prev_tag }}"
          notes="release_notes.md"

          if [ -n "$prev_tag" ]; then
            range="${prev_tag}..${tag}"
            header="Changes since ${prev_tag}"
          else
            range="${tag}"
            header="Changes"
          fi

          {
            echo "# ${tag}"
            echo ""
            echo "## ${header}"
            git log --no-merges --pretty=format:'- %s (%h)' "${range}"
            if [ -z "$prev_tag" ]; then
              echo ""
              echo ""
              echo "_First release: no previous tag found._"
            fi
            echo ""
            echo ""
            echo "## Source"
            echo ""
            echo "\`${tag}\` -> \`${{ steps.resolve.outputs.tag_commit }}\`"
            echo ""
            echo "## Docker Image"
            echo ""
            echo "ghcr.io/${{ github.repository_owner }}/railzway:${tag}"
          } > "${notes}"

          if [ ! -s "${notes}" ]; then
            echo "Release notes were not generated."
            exit 1
          fi

      - name: Archive source from tag
        id: archive
        shell: bash
        run: |
          set -euo pipefail

          tag="${{ steps.resolve.outputs.tag }}"
          archive="railzway-${tag}.tar.gz"

          # Archive directly from the tag to avoid HEAD ambiguity.
          git archive --format=tar.gz --prefix="railzway-${tag}/" "${tag}" > "${archive}"

          echo "file=${archive}" >> "$GITHUB_OUTPUT"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.resolve.outputs.tag }}
          name: ${{ steps.resolve.outputs.tag }}
          body_path: release_notes.md
          files: ${{ steps.archive.outputs.file }}
          fail_on_unmatched_files: true
