version: "3.8"

services:
  # ==========================================
  # Infrastructure
  # ==========================================
  postgres:
    image: postgres:15-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: railzway
      POSTGRES_PASSWORD: password
      POSTGRES_DB: railzway
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U railzway"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 5s
      retries: 5

  # ==========================================
  # Railzway Services
  # ==========================================
  
  # 1. Admin Dashboard (Control Plane)
  # Accessible at http://localhost:8080
  admin:
    build:
      context: .
      target: railzway-admin
    # image: ghcr.io/smallbiznis/railzway/railzway-admin:latest 
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DB_HOST=postgres
      - DB_USER=railzway
      - DB_PASSWORD=password
      - DB_NAME=railzway
      - REDIS_HOST=redis
      - GIN_MODE=debug # Use release in production
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    volumes:
      - railzway_data:/var/lib/railzway

  # 2. Invoice Checkout UI (Customer Plane)
  # Accessible at http://localhost:3000
  invoice:
    build:
      context: .
      target: railzway-invoice
    # image: ghcr.io/smallbiznis/railzway/railzway-invoice:latest
    restart: unless-stopped
    ports:
      - "3000:8080" # Mapping internal 8080 to external 3000
    environment:
      - PORT=8080
      - DB_HOST=postgres
      - DB_USER=railzway
      - DB_PASSWORD=password
      - DB_NAME=railzway
      - REDIS_HOST=redis
      - API_URL=http://admin:8080 # Points to Admin service for API calls
      - GIN_MODE=debug
    depends_on:
      admin:
        condition: service_started

  # 3. Scheduler (Background Plane)
  # Runs async jobs like rating and invoicing
  scheduler:
    build:
      context: .
      target: railzway-scheduler
    # image: ghcr.io/smallbiznis/railzway/railzway-scheduler:latest
    restart: unless-stopped
    environment:
      - ENABLED_JOBS=billing,usage,invoice
      - DB_HOST=postgres
      - DB_USER=railzway
      - DB_PASSWORD=password
      - DB_NAME=railzway
      - REDIS_HOST=redis
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy

  # 4. Migration Runner (One-off)
  # Run manually with: docker-compose run --rm migration
  migration:
    build:
      context: .
      target: railzway-migration
    # image: ghcr.io/smallbiznis/railzway/railzway-migration:latest
    profiles: ["tools"] # Don't start automatically
    environment:
      - DB_HOST=postgres
      - DB_USER=railzway
      - DB_PASSWORD=password
      - DB_NAME=railzway

volumes:
  postgres_data:
  railzway_data:
